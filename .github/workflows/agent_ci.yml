name: Agent CI

on:
  pull_request:
  workflow_dispatch:

jobs:
  builder_agent:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install API deps
        run: |
          python -m pip install --upgrade pip
          pip install -r services/api/requirements.txt
      - name: Builder smoke (schemas + unit tests)
        run: |
          python services/api/scripts/validate_schemas.py
          pytest -q

  verifier_agent:
    runs-on: ubuntu-latest
    needs: builder_agent
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install API deps
        run: |
          python -m pip install --upgrade pip
          pip install -r services/api/requirements.txt
      - name: Contract tests (determinism + immutability)
        run: |
          python services/api/scripts/agent_contract_tests.py

  redteam_agent:
    runs-on: ubuntu-latest
    needs: verifier_agent
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install API deps
        run: |
          python -m pip install --upgrade pip
          pip install -r services/api/requirements.txt
      - name: Red-team checks (tier leaks / audit bypass)
        run: |
          python services/api/scripts/redteam_checks.py
