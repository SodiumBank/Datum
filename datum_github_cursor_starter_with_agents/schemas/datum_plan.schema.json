{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://datum.example/schemas/datum_plan.schema.json",
  "title": "DatumPlan (Deterministic, Revision-Controlled)",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "id", "org_id", "design_id",
    "revision_id", "quote_id", "quote_version",
    "plan_revision", "locked", "steps",
    "derived_from_ruleset", "created_at"
  ],
  "properties": {
    "id": { "$ref": "./datum_common.schema.json#/$defs/id" },
    "org_id": { "$ref": "./datum_common.schema.json#/$defs/id" },
    "design_id": { "$ref": "./datum_common.schema.json#/$defs/id" },
    "revision_id": { "$ref": "./datum_common.schema.json#/$defs/id" },
    "quote_id": { "$ref": "./datum_common.schema.json#/$defs/id" },
    "quote_version": { "type": "integer", "minimum": 1, "maximum": 9999 },
    "plan_revision": { "type": "string", "pattern": "^[A-Z]{1,2}$" },
    "locked": { "type": "boolean" },
    "lock_id": { "$ref": "./datum_common.schema.json#/$defs/id" },
    "derived_from_ruleset": {
      "type": "object",
      "additionalProperties": false,
      "required": ["ruleset_id", "ruleset_version"],
      "properties": {
        "ruleset_id": { "$ref": "./datum_common.schema.json#/$defs/id" },
        "ruleset_version": { "type": "integer", "minimum": 1, "maximum": 999999 }
      }
    },
    "steps": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "./datum_plan_step.schema.json" }
    },
    "eee_requirements": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "full_cert_traceability": { "type": "boolean", "default": false },
        "lot_date_code_capture": { "type": "boolean", "default": false },
        "ab_lot_testing_required": { "type": "boolean", "default": false },
        "storage_controls_required": { "type": "boolean", "default": false }
      }
    },
    "notes": { "type": "string", "maxLength": 4096 },
    "created_at": { "$ref": "./datum_common.schema.json#/$defs/isoTimestamp" },
    "updated_at": { "$ref": "./datum_common.schema.json#/$defs/isoTimestamp" }
  }
}
