{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://datum.example/schemas/datum_plan.schema.json",
  "title": "DatumPlan (Deterministic, Revision-Controlled)",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "id", "org_id", "design_id",
    "revision_id", "quote_id", "quote_version",
    "plan_revision", "locked", "steps",
    "derived_from_ruleset", "created_at"
  ],
  "properties": {
    "id": { "$ref": "./datum_common.schema.json#/$defs/id" },
    "org_id": { "$ref": "./datum_common.schema.json#/$defs/id" },
    "design_id": { "$ref": "./datum_common.schema.json#/$defs/id" },
    "revision_id": { "$ref": "./datum_common.schema.json#/$defs/id" },
    "quote_id": { "$ref": "./datum_common.schema.json#/$defs/id" },
    "quote_version": { "type": "integer", "minimum": 1, "maximum": 9999 },
    "plan_revision": { "type": "string", "pattern": "^[A-Z]{1,2}$" },
    "locked": { "type": "boolean" },
    "lock_id": { "$ref": "./datum_common.schema.json#/$defs/id" },
    "version": {
      "type": "integer",
      "minimum": 1,
      "description": "Plan version number (increments with each edit)"
    },
    "parent_version": {
      "type": "integer",
      "description": "Parent version this plan was edited from"
    },
    "state": {
      "type": "string",
      "enum": ["draft", "submitted", "approved", "rejected"],
      "default": "draft",
      "description": "Plan approval state"
    },
    "edit_metadata": {
      "type": "object",
      "properties": {
        "edited_by": { "$ref": "./datum_common.schema.json#/$defs/id" },
        "edited_at": { "$ref": "./datum_common.schema.json#/$defs/isoTimestamp" },
        "edit_reason": { "type": "string", "maxLength": 512 },
        "overrides": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["constraint", "reason", "user_id", "timestamp"],
            "properties": {
              "constraint": { "type": "string" },
              "reason": { "type": "string" },
              "user_id": { "$ref": "./datum_common.schema.json#/$defs/id" },
              "timestamp": { "$ref": "./datum_common.schema.json#/$defs/isoTimestamp" }
            }
          }
        }
      }
    },
    "derived_from_ruleset": {
      "type": "object",
      "additionalProperties": false,
      "required": ["ruleset_id", "ruleset_version"],
      "properties": {
        "ruleset_id": { "$ref": "./datum_common.schema.json#/$defs/id" },
        "ruleset_version": { "type": "integer", "minimum": 1, "maximum": 999999 }
      }
    },
    "steps": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "./datum_plan_step.schema.json" }
    },
    "soe_run_id": {
      "type": "string",
      "description": "Reference to the SOERun that generated this plan"
    },
    "soe_decision_ids": {
      "type": "array",
      "items": { "type": "string", "pattern": "^DEC-[0-9A-F]{8}$" },
      "description": "List of SOE decision IDs that influenced this plan",
      "default": []
    },
    "tests": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["test_id", "test_type", "required", "soe_decision_id"],
        "properties": {
          "test_id": { "$ref": "./datum_common.schema.json#/$defs/id" },
          "test_type": { "type": "string" },
          "title": { "type": "string" },
          "required": { "type": "boolean" },
          "acceptance_criteria": { "type": "string" },
          "soe_decision_id": { "type": "string", "pattern": "^DEC-[0-9A-F]{8}$" },
          "soe_why": {
            "type": "object",
            "properties": {
              "rule_id": { "type": "string" },
              "pack_id": { "type": "string" },
              "citations": { "type": "array", "items": { "type": "string" } }
            }
          }
        }
      },
      "description": "Test intent derived from SOE decisions",
      "default": []
    },
    "evidence_intent": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["evidence_id", "evidence_type", "retention", "soe_decision_id"],
        "properties": {
          "evidence_id": { "$ref": "./datum_common.schema.json#/$defs/id" },
          "evidence_type": { "type": "string" },
          "applies_to": { "type": "string" },
          "object_id": { "type": "string" },
          "retention": { "type": "string" },
          "soe_decision_id": { "type": "string", "pattern": "^DEC-[0-9A-F]{8}$" },
          "soe_why": {
            "type": "object",
            "properties": {
              "rule_id": { "type": "string" },
              "pack_id": { "type": "string" },
              "citations": { "type": "array", "items": { "type": "string" } }
            }
          }
        }
      },
      "description": "Evidence requirements derived from SOE decisions",
      "default": []
    },
    "eee_requirements": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "full_cert_traceability": { "type": "boolean", "default": false },
        "lot_date_code_capture": { "type": "boolean", "default": false },
        "ab_lot_testing_required": { "type": "boolean", "default": false },
        "storage_controls_required": { "type": "boolean", "default": false }
      }
    },
    "notes": { "type": "string", "maxLength": 4096 },
    "created_at": { "$ref": "./datum_common.schema.json#/$defs/isoTimestamp" },
    "updated_at": { "$ref": "./datum_common.schema.json#/$defs/isoTimestamp" }
  }
}
