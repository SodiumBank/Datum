{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://datum.example/schemas/datum_outputs.schema.json",
  "title": "DatumOutputs (Tier 3 Execution Artifacts)",
  "type": "object",
  "additionalProperties": false,
  "required": ["id", "revision_id", "plan_id", "plan_revision", "outputs"],
  "properties": {
    "id": { "$ref": "./datum_common.schema.json#/$defs/id" },
    "revision_id": { "$ref": "./datum_common.schema.json#/$defs/id" },
    "plan_id": { "$ref": "./datum_common.schema.json#/$defs/id" },
    "plan_revision": { "type": "string", "pattern": "^[A-Z]{1,2}$" },
    "outputs": {
      "type": "array",
      "minItems": 0,
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["output_type", "approved", "data"],
        "properties": {
          "output_type": {
            "type": "string",
            "enum": ["STENCIL","PLACEMENT","SELECTIVE_SOLDER","LEAD_FORM","PROGRAMMING","REFLOW_PROFILE","AOI_TEMPLATE"]
          },
          "approved": { "type": "boolean" },
          "approved_by": { "$ref": "./datum_common.schema.json#/$defs/id" },
          "approved_at": { "$ref": "./datum_common.schema.json#/$defs/isoTimestamp" },
          "data": { "type": "object" },
          "source_rules": { "type": "array", "items": { "$ref": "./datum_rule_ref.schema.json" } }
        },
        "allOf": [
          { "if": { "properties": { "output_type": { "const": "STENCIL" } } },
            "then": { "properties": { "data": { "$ref": "./datum_output_stencil.schema.json" } } } },
          { "if": { "properties": { "output_type": { "const": "PLACEMENT" } } },
            "then": { "properties": { "data": { "$ref": "./datum_output_placement.schema.json" } } } },
          { "if": { "properties": { "output_type": { "const": "SELECTIVE_SOLDER" } } },
            "then": { "properties": { "data": { "$ref": "./datum_output_selective_solder.schema.json" } } } },
          { "if": { "properties": { "output_type": { "const": "PROGRAMMING" } } },
            "then": { "properties": { "data": { "$ref": "./datum_output_programming.schema.json" } } } },
          { "if": { "properties": { "output_type": { "const": "LEAD_FORM" } } },
            "then": { "properties": { "data": {
              "type": "object",
              "additionalProperties": false,
              "required": ["items","inspection"],
              "properties": {
                "items": { "type": "array", "minItems": 1, "items": {
                  "type": "object",
                  "additionalProperties": false,
                  "required": ["refdes","target_lead_length_mm"],
                  "properties": {
                    "refdes": { "type": "string", "maxLength": 32 },
                    "target_lead_length_mm": { "type": "number", "minimum": 0.1, "maximum": 50.0 },
                    "bend_radius_mm": { "type": "number", "minimum": 0.0, "maximum": 25.0 },
                    "method": { "type": "string", "enum": ["MANUAL","SEMI_AUTOMATIC","AUTOMATIC"], "default": "MANUAL" },
                    "notes": { "type": "string", "maxLength": 256 }
                  }
                }},
                "inspection": { "type": "object", "additionalProperties": false, "required": ["criteria"],
                  "properties": {
                    "criteria": { "type": "string", "maxLength": 1024 },
                    "sampling": { "type": "string", "enum": ["100_PERCENT","LOT_SAMPLE","AQL"], "default": "100_PERCENT" }
                  }
                }
              }
            } } } },
          { "if": { "properties": { "output_type": { "const": "REFLOW_PROFILE" } } },
            "then": { "properties": { "data": {
              "type": "object",
              "additionalProperties": false,
              "required": ["profile_id","paste_type","parameters"],
              "properties": {
                "profile_id": { "type": "string", "maxLength": 64 },
                "paste_type": { "type": "string", "enum": ["LEADFREE","LEADED"] },
                "parameters": { "type": "object", "additionalProperties": false,
                  "required": ["ramp_rate_c_per_s","soak_s","peak_c","time_above_liquidus_s","cool_rate_c_per_s"],
                  "properties": {
                    "ramp_rate_c_per_s": { "type": "number", "minimum": 0.1, "maximum": 5.0 },
                    "soak_s": { "type": "integer", "minimum": 0, "maximum": 1200 },
                    "peak_c": { "type": "number", "minimum": 150, "maximum": 280 },
                    "time_above_liquidus_s": { "type": "integer", "minimum": 0, "maximum": 300 },
                    "cool_rate_c_per_s": { "type": "number", "minimum": 0.1, "maximum": 10.0 }
                  }
                },
                "notes": { "type": "string", "maxLength": 512 }
              }
            } } } },
          { "if": { "properties": { "output_type": { "const": "AOI_TEMPLATE" } } },
            "then": { "properties": { "data": {
              "type": "object",
              "additionalProperties": false,
              "required": ["focus_areas","criteria"],
              "properties": {
                "focus_areas": { "type": "array", "minItems": 1, "items": {
                  "type": "object",
                  "additionalProperties": false,
                  "required": ["refdes","reason"],
                  "properties": {
                    "refdes": { "type": "string", "maxLength": 32 },
                    "reason": { "type": "string", "maxLength": 256 }
                  }
                }},
                "criteria": { "type": "string", "maxLength": 2048 },
                "notes": { "type": "string", "maxLength": 512 }
              }
            } } } }
        ]
      }
    }
  }
}
